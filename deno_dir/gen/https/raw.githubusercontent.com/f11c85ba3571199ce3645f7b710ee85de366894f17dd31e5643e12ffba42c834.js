import { get } from "./utils/get.ts";
export function getSourceItemUniqueKey(item, sourceIndex, sourceOptions) {
    const defaultKeysFields = [
        "id",
        "guid",
        "_id",
        "objectId",
        "objectID",
        "ID",
        "url",
        "link",
    ];
    const keyFields = sourceOptions.key
        ? [sourceOptions.key].concat(defaultKeysFields)
        : defaultKeysFields;
    let itemKey;
    for (let keyFieldIndex = 0; keyFieldIndex < keyFields.length; keyFieldIndex++) {
        const keyField = keyFields[keyFieldIndex];
        itemKey = get(item, keyField);
        if (typeof itemKey === "string") {
            break;
        }
    }
    const sourcePrefix = sourceOptions.id || sourceIndex;
    if (itemKey) {
        return `${sourcePrefix}${itemKey}`;
    }
    else {
        return undefined;
    }
}
export function getSourceItemsFromResult(ctx, sourceOptions) {
    const { reporter } = sourceOptions;
    const force = sourceOptions?.force;
    let items = ctx.public.result;
    if (sourceOptions.itemsPath) {
        items = get(ctx.public.result, sourceOptions.itemsPath);
    }
    if (!Array.isArray(items)) {
        throw new Error("source result must be an array, but got " + typeof items);
    }
    const finalItems = [];
    for (let itemIndex = 0; itemIndex < items.length; itemIndex++) {
        const item = items[itemIndex];
        const key = getSourceItemUniqueKey(item, ctx.public.sourceIndex, sourceOptions);
        if (key === undefined) {
            reporter.warning(`will be directly added to items`, "No unique key");
        }
        if (key !== undefined && ctx.internalState &&
            (ctx.internalState.keys || []).includes(key) &&
            !force) {
            reporter.debug(`${key}, cause it has been processed`, "Skip item");
            continue;
        }
        else if (key !== undefined && ctx.internalState &&
            (ctx.internalState.keys || []).includes(key) && force) {
            reporter.debug(`${key}, cause --force is true`, "Add processed item");
        }
        else if (force) {
            reporter.debug(`${key}`, "add item");
        }
        finalItems.push(item);
    }
    ctx.public.items = finalItems;
    return ctx;
}
export function filterCtxItems(ctx, filterOptions) {
    const { reporter } = filterOptions;
    const limit = filterOptions?.limit;
    const items = ctx.public.items;
    if (!Array.isArray(items)) {
        throw new Error("ctx.items must be an array, but got " + typeof items + ", filter failed");
    }
    reporter.debug(`Input ${items.length} items`);
    const finalItems = [];
    const finalItemKeys = [];
    const finalItemSourceOptions = [];
    for (let i = 0; i < items.length; i++) {
        if (limit !== undefined && limit > 0 && finalItems.length >= limit) {
            break;
        }
        const item = items[i];
        finalItems.push(item);
    }
    ctx.public.items = finalItems;
    reporter.debug(`Output ${ctx.public.items.length} items`);
    return ctx;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXNvdXJjZS1pdGVtcy1mcm9tLXJlc3VsdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1zb3VyY2UtaXRlbXMtZnJvbS1yZXN1bHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTXJDLE1BQU0sVUFBVSxzQkFBc0IsQ0FDcEMsSUFBYSxFQUNiLFdBQW1CLEVBQ25CLGFBQTRCO0lBRTVCLE1BQU0saUJBQWlCLEdBQUc7UUFDeEIsSUFBSTtRQUNKLE1BQU07UUFDTixLQUFLO1FBQ0wsVUFBVTtRQUNWLFVBQVU7UUFDVixJQUFJO1FBQ0osS0FBSztRQUNMLE1BQU07S0FDUCxDQUFDO0lBQ0YsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLEdBQUc7UUFDakMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQztRQUMvQyxDQUFDLENBQUMsaUJBQWlCLENBQUM7SUFFdEIsSUFBSSxPQUFPLENBQUM7SUFDWixLQUNFLElBQUksYUFBYSxHQUFHLENBQUMsRUFDckIsYUFBYSxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQ2hDLGFBQWEsRUFBRSxFQUNmO1FBQ0EsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzFDLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzlCLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO1lBQy9CLE1BQU07U0FDUDtLQUNGO0lBQ0QsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLEVBQUUsSUFBSSxXQUFXLENBQUM7SUFDckQsSUFBSSxPQUFPLEVBQUU7UUFDWCxPQUFPLEdBQUcsWUFBWSxHQUFHLE9BQU8sRUFBRSxDQUFDO0tBQ3BDO1NBQU07UUFDTCxPQUFPLFNBQVMsQ0FBQztLQUNsQjtBQUNILENBQUM7QUFDRCxNQUFNLFVBQVUsd0JBQXdCLENBQ3RDLEdBQVksRUFDWixhQUFrQztJQUVsQyxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsYUFBYSxDQUFDO0lBRW5DLE1BQU0sS0FBSyxHQUFHLGFBQWEsRUFBRSxLQUFLLENBQUM7SUFHbkMsSUFBSSxLQUFLLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFFOUIsSUFBSSxhQUFhLENBQUMsU0FBUyxFQUFFO1FBQzNCLEtBQUssR0FBRyxHQUFHLENBQ1QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFpQyxFQUM1QyxhQUFhLENBQUMsU0FBUyxDQUN4QixDQUFDO0tBQ0g7SUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUN6QixNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxHQUFHLE9BQU8sS0FBSyxDQUFDLENBQUM7S0FDNUU7SUFFRCxNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7SUFDdEIsS0FBSyxJQUFJLFNBQVMsR0FBRyxDQUFDLEVBQUUsU0FBUyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLEVBQUU7UUFFN0QsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlCLE1BQU0sR0FBRyxHQUFHLHNCQUFzQixDQUNoQyxJQUFJLEVBQ0osR0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFZLEVBQ3ZCLGFBQWEsQ0FDZCxDQUFDO1FBQ0YsSUFBSSxHQUFHLEtBQUssU0FBUyxFQUFFO1lBQ3JCLFFBQVEsQ0FBQyxPQUFPLENBQ2QsaUNBQWlDLEVBQ2pDLGVBQWUsQ0FDaEIsQ0FBQztTQUNIO1FBRUQsSUFDRSxHQUFHLEtBQUssU0FBUyxJQUFJLEdBQUcsQ0FBQyxhQUFhO1lBQ3RDLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztZQUM1QyxDQUFDLEtBQUssRUFDTjtZQUNBLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLCtCQUErQixFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ25FLFNBQVM7U0FDVjthQUFNLElBQ0wsR0FBRyxLQUFLLFNBQVMsSUFBSSxHQUFHLENBQUMsYUFBYTtZQUN0QyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLEVBQ3JEO1lBQ0EsUUFBUSxDQUFDLEtBQUssQ0FDWixHQUFHLEdBQUcseUJBQXlCLEVBQy9CLG9CQUFvQixDQUNyQixDQUFDO1NBQ0g7YUFBTSxJQUFJLEtBQUssRUFBRTtZQUNoQixRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUM7U0FDdEM7UUFFRCxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3ZCO0lBRUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsVUFBVSxDQUFDO0lBRTlCLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQUVELE1BQU0sVUFBVSxjQUFjLENBQzVCLEdBQVksRUFDWixhQUFrQztJQUVsQyxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsYUFBYSxDQUFDO0lBRW5DLE1BQU0sS0FBSyxHQUFHLGFBQWEsRUFBRSxLQUFLLENBQUM7SUFFbkMsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFFL0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDekIsTUFBTSxJQUFJLEtBQUssQ0FDYixzQ0FBc0MsR0FBRyxPQUFPLEtBQUssR0FBRyxpQkFBaUIsQ0FDMUUsQ0FBQztLQUNIO0lBQ0QsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssQ0FBQyxNQUFNLFFBQVEsQ0FBQyxDQUFDO0lBRTlDLE1BQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQztJQUN0QixNQUFNLGFBQWEsR0FBRyxFQUFFLENBQUM7SUFDekIsTUFBTSxzQkFBc0IsR0FBRyxFQUFFLENBQUM7SUFDbEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFHckMsSUFDRSxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksVUFBVSxDQUFDLE1BQU0sSUFBSSxLQUFLLEVBQzlEO1lBQ0EsTUFBTTtTQUNQO1FBQ0QsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXRCLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdkI7SUFFRCxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUM7SUFFOUIsUUFBUSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sUUFBUSxDQUFDLENBQUM7SUFFMUQsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU291cmNlT3B0aW9ucyB9IGZyb20gXCIuL2ludGVyZmFjZS50c1wiO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSBcIi4vdXRpbHMvZ2V0LnRzXCI7XG5pbXBvcnQgeyBsb2cgfSBmcm9tIFwiLi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCIuL2ludGVybmFsLWludGVyZmFjZS50c1wiO1xuaW50ZXJmYWNlIEZpbHRlclRyaWdnZXJPcHRpb24gZXh0ZW5kcyBTb3VyY2VPcHRpb25zIHtcbiAgcmVwb3J0ZXI6IGxvZy5Mb2dnZXI7XG59XG5leHBvcnQgZnVuY3Rpb24gZ2V0U291cmNlSXRlbVVuaXF1ZUtleShcbiAgaXRlbTogdW5rbm93bixcbiAgc291cmNlSW5kZXg6IG51bWJlcixcbiAgc291cmNlT3B0aW9uczogU291cmNlT3B0aW9ucyxcbik6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGRlZmF1bHRLZXlzRmllbGRzID0gW1xuICAgIFwiaWRcIixcbiAgICBcImd1aWRcIixcbiAgICBcIl9pZFwiLFxuICAgIFwib2JqZWN0SWRcIixcbiAgICBcIm9iamVjdElEXCIsXG4gICAgXCJJRFwiLFxuICAgIFwidXJsXCIsXG4gICAgXCJsaW5rXCIsXG4gIF07XG4gIGNvbnN0IGtleUZpZWxkcyA9IHNvdXJjZU9wdGlvbnMua2V5XG4gICAgPyBbc291cmNlT3B0aW9ucy5rZXldLmNvbmNhdChkZWZhdWx0S2V5c0ZpZWxkcylcbiAgICA6IGRlZmF1bHRLZXlzRmllbGRzO1xuICAvLyB1bmlxdWUga2V5XG4gIGxldCBpdGVtS2V5O1xuICBmb3IgKFxuICAgIGxldCBrZXlGaWVsZEluZGV4ID0gMDtcbiAgICBrZXlGaWVsZEluZGV4IDwga2V5RmllbGRzLmxlbmd0aDtcbiAgICBrZXlGaWVsZEluZGV4KytcbiAgKSB7XG4gICAgY29uc3Qga2V5RmllbGQgPSBrZXlGaWVsZHNba2V5RmllbGRJbmRleF07XG4gICAgaXRlbUtleSA9IGdldChpdGVtLCBrZXlGaWVsZCk7XG4gICAgaWYgKHR5cGVvZiBpdGVtS2V5ID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgY29uc3Qgc291cmNlUHJlZml4ID0gc291cmNlT3B0aW9ucy5pZCB8fCBzb3VyY2VJbmRleDtcbiAgaWYgKGl0ZW1LZXkpIHtcbiAgICByZXR1cm4gYCR7c291cmNlUHJlZml4fSR7aXRlbUtleX1gO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRTb3VyY2VJdGVtc0Zyb21SZXN1bHQoXG4gIGN0eDogQ29udGV4dCxcbiAgc291cmNlT3B0aW9uczogRmlsdGVyVHJpZ2dlck9wdGlvbixcbik6IENvbnRleHQge1xuICBjb25zdCB7IHJlcG9ydGVyIH0gPSBzb3VyY2VPcHRpb25zO1xuICAvLyBmb3JtYXRcbiAgY29uc3QgZm9yY2UgPSBzb3VyY2VPcHRpb25zPy5mb3JjZTtcblxuICAvLyBnZXQgaXRlbXMgcGF0aCwgZ2V0IGRlZHVwbGljYXRpb24ga2V5XG4gIGxldCBpdGVtcyA9IGN0eC5wdWJsaWMucmVzdWx0O1xuXG4gIGlmIChzb3VyY2VPcHRpb25zLml0ZW1zUGF0aCkge1xuICAgIGl0ZW1zID0gZ2V0KFxuICAgICAgY3R4LnB1YmxpYy5yZXN1bHQgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgICBzb3VyY2VPcHRpb25zLml0ZW1zUGF0aCxcbiAgICApO1xuICB9XG5cbiAgaWYgKCFBcnJheS5pc0FycmF5KGl0ZW1zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcInNvdXJjZSByZXN1bHQgbXVzdCBiZSBhbiBhcnJheSwgYnV0IGdvdCBcIiArIHR5cGVvZiBpdGVtcyk7XG4gIH1cblxuICBjb25zdCBmaW5hbEl0ZW1zID0gW107XG4gIGZvciAobGV0IGl0ZW1JbmRleCA9IDA7IGl0ZW1JbmRleCA8IGl0ZW1zLmxlbmd0aDsgaXRlbUluZGV4KyspIHtcbiAgICAvLyByZWFjaCBtYXggaXRlbXNcbiAgICBjb25zdCBpdGVtID0gaXRlbXNbaXRlbUluZGV4XTtcblxuICAgIGNvbnN0IGtleSA9IGdldFNvdXJjZUl0ZW1VbmlxdWVLZXkoXG4gICAgICBpdGVtLFxuICAgICAgY3R4LnB1YmxpYy5zb3VyY2VJbmRleCEsXG4gICAgICBzb3VyY2VPcHRpb25zLFxuICAgICk7XG4gICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXBvcnRlci53YXJuaW5nKFxuICAgICAgICBgd2lsbCBiZSBkaXJlY3RseSBhZGRlZCB0byBpdGVtc2AsXG4gICAgICAgIFwiTm8gdW5pcXVlIGtleVwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBrZXkgIT09IHVuZGVmaW5lZCAmJiBjdHguaW50ZXJuYWxTdGF0ZSAmJlxuICAgICAgKGN0eC5pbnRlcm5hbFN0YXRlLmtleXMgfHwgW10pLmluY2x1ZGVzKGtleSkgJiZcbiAgICAgICFmb3JjZVxuICAgICkge1xuICAgICAgcmVwb3J0ZXIuZGVidWcoYCR7a2V5fSwgY2F1c2UgaXQgaGFzIGJlZW4gcHJvY2Vzc2VkYCwgXCJTa2lwIGl0ZW1cIik7XG4gICAgICBjb250aW51ZTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAga2V5ICE9PSB1bmRlZmluZWQgJiYgY3R4LmludGVybmFsU3RhdGUgJiZcbiAgICAgIChjdHguaW50ZXJuYWxTdGF0ZS5rZXlzIHx8IFtdKS5pbmNsdWRlcyhrZXkpICYmIGZvcmNlXG4gICAgKSB7XG4gICAgICByZXBvcnRlci5kZWJ1ZyhcbiAgICAgICAgYCR7a2V5fSwgY2F1c2UgLS1mb3JjZSBpcyB0cnVlYCxcbiAgICAgICAgXCJBZGQgcHJvY2Vzc2VkIGl0ZW1cIixcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChmb3JjZSkge1xuICAgICAgcmVwb3J0ZXIuZGVidWcoYCR7a2V5fWAsIFwiYWRkIGl0ZW1cIik7XG4gICAgfVxuXG4gICAgZmluYWxJdGVtcy5wdXNoKGl0ZW0pO1xuICB9XG4gIC8vIHNhdmUgY3VycmVudCBrZXkgdG8gZGJcbiAgY3R4LnB1YmxpYy5pdGVtcyA9IGZpbmFsSXRlbXM7XG5cbiAgcmV0dXJuIGN0eDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbHRlckN0eEl0ZW1zKFxuICBjdHg6IENvbnRleHQsXG4gIGZpbHRlck9wdGlvbnM6IEZpbHRlclRyaWdnZXJPcHRpb24sXG4pOiBDb250ZXh0IHtcbiAgY29uc3QgeyByZXBvcnRlciB9ID0gZmlsdGVyT3B0aW9ucztcbiAgLy8gZm9ybWF0XG4gIGNvbnN0IGxpbWl0ID0gZmlsdGVyT3B0aW9ucz8ubGltaXQ7XG4gIC8vIGdldCBpdGVtcyBwYXRoLCBnZXQgZGVkdXBsaWNhdGlvbiBrZXlcbiAgY29uc3QgaXRlbXMgPSBjdHgucHVibGljLml0ZW1zO1xuXG4gIGlmICghQXJyYXkuaXNBcnJheShpdGVtcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBcImN0eC5pdGVtcyBtdXN0IGJlIGFuIGFycmF5LCBidXQgZ290IFwiICsgdHlwZW9mIGl0ZW1zICsgXCIsIGZpbHRlciBmYWlsZWRcIixcbiAgICApO1xuICB9XG4gIHJlcG9ydGVyLmRlYnVnKGBJbnB1dCAke2l0ZW1zLmxlbmd0aH0gaXRlbXNgKTtcblxuICBjb25zdCBmaW5hbEl0ZW1zID0gW107XG4gIGNvbnN0IGZpbmFsSXRlbUtleXMgPSBbXTtcbiAgY29uc3QgZmluYWxJdGVtU291cmNlT3B0aW9ucyA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgLy8gcmVhY2ggbWF4IGl0ZW1zXG5cbiAgICBpZiAoXG4gICAgICBsaW1pdCAhPT0gdW5kZWZpbmVkICYmIGxpbWl0ID4gMCAmJiBmaW5hbEl0ZW1zLmxlbmd0aCA+PSBsaW1pdFxuICAgICkge1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNvbnN0IGl0ZW0gPSBpdGVtc1tpXTtcblxuICAgIGZpbmFsSXRlbXMucHVzaChpdGVtKTtcbiAgfVxuICAvLyBzYXZlIGN1cnJlbnQga2V5IHRvIGRiXG4gIGN0eC5wdWJsaWMuaXRlbXMgPSBmaW5hbEl0ZW1zO1xuXG4gIHJlcG9ydGVyLmRlYnVnKGBPdXRwdXQgJHtjdHgucHVibGljLml0ZW1zLmxlbmd0aH0gaXRlbXNgKTtcblxuICByZXR1cm4gY3R4O1xufVxuIl19