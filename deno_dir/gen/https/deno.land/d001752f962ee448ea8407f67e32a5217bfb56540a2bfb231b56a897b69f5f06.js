import { Store } from "./json-store.ts";
import { Adapters, Keydb } from "../../deps.ts";
export class JsonStoreAdapter {
    namespaces = new Map();
    path = "data";
    constructor(path){
        this.path = path ?? this.path;
    }
    static getDataPathFromUri(uri) {
        if (!uri) {
            return undefined;
        }
        let path = uri.toString().slice(5);
        if (path.startsWith("//")) path = path.slice(2);
        return path;
    }
    checkNamespace(ns) {
        if (this.namespaces.has(ns)) {
            return;
        } else {
            this.namespaces.set(ns, new Store({
                name: `${ns}.json`,
                path: `${this.path}`
            }));
        }
    }
    ns(ns) {
        if (ns === "") {
            ns = "default-data";
        }
        this.checkNamespace(ns);
        return this.namespaces.get(ns);
    }
    // deno-lint-ignore no-explicit-any
    async set(k, v, ns = "", ttl = 0) {
        const n = this.ns(ns);
        await n.set(k, {
            value: v,
            ttl
        });
        return this;
    }
    async get(k, ns = "") {
        const n = this.ns(ns);
        const v = await n?.get(k);
        return !v ? undefined : {
            key: k,
            ns,
            value: v.value,
            ttl: v.ttl
        };
    }
    async has(k, ns = "") {
        const n = this.ns(ns);
        return await n.has(k) ?? false;
    }
    async delete(k, ns = "") {
        const n = this.ns(ns);
        return await n?.delete(k) ?? false;
    }
    async keys(ns = "") {
        const n = this.ns(ns);
        const obj = await n.toObject();
        return [
            ...Object.keys(obj) ?? []
        ];
    }
    async clear(ns = "") {
        const n = this.ns(ns);
        await n.clear();
        return this;
    }
    async deleteExpired(ns = "") {
        const obj = await this.ns(ns).toObject();
        const n = this.ns(ns);
        for (const k of Object.keys(obj)){
            const v = obj[k];
            if (v.ttl !== 0 && Date.now() > v.ttl) {
                delete obj[k];
            }
        }
        await n.set(obj);
    }
}
Adapters.register({
    protocol: "json",
    init (uri) {
        const path = JsonStoreAdapter.getDataPathFromUri(uri.toString());
        const store = new JsonStoreAdapter(path);
        return store;
    }
});
export { Keydb };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvZGVub2Zsb3dAMC4wLjMzL2NvcmUvYWRhcHRlcnMvanNvbi1zdG9yZS1hZGFwdGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0b3JlIH0gZnJvbSBcIi4vanNvbi1zdG9yZS50c1wiO1xuXG5pbXBvcnQgeyBBZGFwdGVyLCBBZGFwdGVycywgS2V5ZGIsIEtleWRiRmllbGRzIH0gZnJvbSBcIi4uLy4uL2RlcHMudHNcIjtcblxuZXhwb3J0IGNsYXNzIEpzb25TdG9yZUFkYXB0ZXIgaW1wbGVtZW50cyBBZGFwdGVyIHtcbiAgbmFtZXNwYWNlczogTWFwPFxuICAgIHN0cmluZyxcbiAgICBTdG9yZVxuICA+ID0gbmV3IE1hcCgpO1xuICBwYXRoID0gXCJkYXRhXCI7XG4gIGNvbnN0cnVjdG9yKHBhdGg/OiBzdHJpbmcpIHtcbiAgICB0aGlzLnBhdGggPSBwYXRoID8/IHRoaXMucGF0aDtcbiAgfVxuICBzdGF0aWMgZ2V0RGF0YVBhdGhGcm9tVXJpKHVyaTogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIXVyaSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgbGV0IHBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVyaS50b1N0cmluZygpLnNsaWNlKDUpO1xuICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoXCIvL1wiKSkgcGF0aCA9IHBhdGguc2xpY2UoMik7XG4gICAgcmV0dXJuIHBhdGg7XG4gIH1cbiAgY2hlY2tOYW1lc3BhY2UobnM6IHN0cmluZykge1xuICAgIGlmICh0aGlzLm5hbWVzcGFjZXMuaGFzKG5zKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm5hbWVzcGFjZXMuc2V0KFxuICAgICAgICBucyxcbiAgICAgICAgbmV3IFN0b3JlKHtcbiAgICAgICAgICBuYW1lOiBgJHtuc30uanNvbmAsXG4gICAgICAgICAgcGF0aDogYCR7dGhpcy5wYXRofWAsXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBucyhuczogc3RyaW5nKTogU3RvcmUge1xuICAgIGlmIChucyA9PT0gXCJcIikge1xuICAgICAgbnMgPSBcImRlZmF1bHQtZGF0YVwiO1xuICAgIH1cbiAgICB0aGlzLmNoZWNrTmFtZXNwYWNlKG5zKTtcbiAgICByZXR1cm4gdGhpcy5uYW1lc3BhY2VzLmdldChucykgYXMgU3RvcmU7XG4gIH1cblxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBhc3luYyBzZXQoazogc3RyaW5nLCB2OiBhbnksIG5zID0gXCJcIiwgdHRsID0gMCkge1xuICAgIGNvbnN0IG4gPSB0aGlzLm5zKG5zKTtcbiAgICBhd2FpdCBuLnNldChrLCB7IHZhbHVlOiB2LCB0dGwgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhc3luYyBnZXQoazogc3RyaW5nLCBucyA9IFwiXCIpOiBQcm9taXNlPEtleWRiRmllbGRzIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgbiA9IHRoaXMubnMobnMpO1xuICAgIGNvbnN0IHYgPSBhd2FpdCBuPy5nZXQoayk7XG4gICAgcmV0dXJuICF2ID8gdW5kZWZpbmVkIDoge1xuICAgICAga2V5OiBrLFxuICAgICAgbnMsXG4gICAgICB2YWx1ZTogKHYgYXMgS2V5ZGJGaWVsZHMpLnZhbHVlLFxuICAgICAgdHRsOiAodiBhcyBLZXlkYkZpZWxkcykudHRsLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBoYXMoazogc3RyaW5nLCBucyA9IFwiXCIpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBuID0gdGhpcy5ucyhucyk7XG5cbiAgICByZXR1cm4gYXdhaXQgbi5oYXMoaykgPz8gZmFsc2U7XG4gIH1cblxuICBhc3luYyBkZWxldGUoazogc3RyaW5nLCBucyA9IFwiXCIpIHtcbiAgICBjb25zdCBuID0gdGhpcy5ucyhucyk7XG4gICAgcmV0dXJuIGF3YWl0IG4/LmRlbGV0ZShrKSA/PyBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIGtleXMobnMgPSBcIlwiKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IG4gPSB0aGlzLm5zKG5zKTtcbiAgICBjb25zdCBvYmogPSBhd2FpdCBuLnRvT2JqZWN0KCk7XG4gICAgcmV0dXJuIFsuLi4oT2JqZWN0LmtleXMob2JqKSA/PyBbXSldO1xuICB9XG5cbiAgYXN5bmMgY2xlYXIobnMgPSBcIlwiKSB7XG4gICAgY29uc3QgbiA9IHRoaXMubnMobnMpO1xuICAgIGF3YWl0IG4uY2xlYXIoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZUV4cGlyZWQobnMgPSBcIlwiKSB7XG4gICAgY29uc3Qgb2JqID0gYXdhaXQgdGhpcy5ucyhucykudG9PYmplY3QoKTtcbiAgICBjb25zdCBuID0gdGhpcy5ucyhucyk7XG4gICAgZm9yIChjb25zdCBrIG9mIE9iamVjdC5rZXlzKG9iaikpIHtcbiAgICAgIGNvbnN0IHYgPSBvYmpba10gYXMgS2V5ZGJGaWVsZHM7XG4gICAgICBpZiAoKHYudHRsKSAhPT0gMCAmJiBEYXRlLm5vdygpID4gdi50dGwpIHtcbiAgICAgICAgZGVsZXRlIG9ialtrXTtcbiAgICAgIH1cbiAgICB9XG4gICAgYXdhaXQgbi5zZXQob2JqKTtcbiAgfVxufVxuQWRhcHRlcnMucmVnaXN0ZXIoe1xuICBwcm90b2NvbDogXCJqc29uXCIsXG4gIGluaXQodXJpKSB7XG4gICAgY29uc3QgcGF0aCA9IEpzb25TdG9yZUFkYXB0ZXIuZ2V0RGF0YVBhdGhGcm9tVXJpKFxuICAgICAgdXJpLnRvU3RyaW5nKCksXG4gICAgKTtcblxuICAgIGNvbnN0IHN0b3JlID0gbmV3IEpzb25TdG9yZUFkYXB0ZXIocGF0aCk7XG4gICAgcmV0dXJuIHN0b3JlO1xuICB9LFxufSk7XG5leHBvcnQgeyBLZXlkYiB9O1xuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQVMsS0FB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