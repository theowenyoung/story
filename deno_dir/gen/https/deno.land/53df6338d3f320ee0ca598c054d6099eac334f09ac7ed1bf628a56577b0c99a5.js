import { SHA1, SHA256, SHA512, encode } from "./deps.ts";
const SHA1_REGEX = /^\s*sha-?1\s*$/i;
const SHA256_REGEX = /^\s*sha-?256\s*$/i;
const SHA512_REGEX = /^\s*sha-?512\s*$/i;
/** A class representation of the HMAC algorithm. */ export class HMAC {
    hashSize;
    B;
    iPad;
    oPad;
    iKeyPad;
    oKeyPad;
    hasher;
    /** Creates a new HMAC instance. */ constructor(hasher, key){
        this.hashSize = hasher.hashSize;
        this.hasher = hasher;
        this.B = this.hashSize <= 32 ? 64 : 128; // according to RFC4868
        this.iPad = 0x36;
        this.oPad = 0x5c;
        if (key) {
            this.init(key);
        }
    }
    /** Initializes an HMAC instance. */ init(key, inputEncoding) {
        if (!key) {
            key = new Uint8Array(0);
        } else if (typeof key === "string") {
            key = encode(key, inputEncoding);
        }
        // process the key
        let _key = new Uint8Array(key);
        if (_key.length > this.B) {
            // keys longer than blocksize are shortened
            this.hasher.init();
            _key = this.hasher.update(key).digest();
        }
        // zeropadr
        if (_key.byteLength < this.B) {
            const tmp = new Uint8Array(this.B);
            tmp.set(_key, 0);
            _key = tmp;
        }
        // setup the key pads
        this.iKeyPad = new Uint8Array(this.B);
        this.oKeyPad = new Uint8Array(this.B);
        for(let i = 0; i < this.B; ++i){
            this.iKeyPad[i] = this.iPad ^ _key[i];
            this.oKeyPad[i] = this.oPad ^ _key[i];
        }
        // blackout key
        _key.fill(0);
        // initial hash
        this.hasher.init();
        this.hasher.update(this.iKeyPad);
        return this;
    }
    /** Update the HMAC with additional message data. */ update(msg = new Uint8Array(0), inputEncoding) {
        if (typeof msg === "string") {
            msg = encode(msg, inputEncoding);
        }
        this.hasher.update(msg);
        return this;
    }
    /** Finalize the HMAC with additional message data. */ digest(outputEncoding) {
        const sum1 = this.hasher.digest(); // get sum 1
        this.hasher.init();
        return this.hasher.update(this.oKeyPad).update(sum1).digest(outputEncoding);
    }
}
/** Returns a HMAC of the given msg and key using the indicated hash. */ export function hmac(hash, key, msg, inputEncoding, outputEncoding) {
    if (SHA1_REGEX.test(hash)) {
        return new HMAC(new SHA1()).init(key, inputEncoding).update(msg, inputEncoding).digest(outputEncoding);
    } else if (SHA256_REGEX.test(hash)) {
        return new HMAC(new SHA256()).init(key, inputEncoding).update(msg, inputEncoding).digest(outputEncoding);
    } else if (SHA512_REGEX.test(hash)) {
        return new HMAC(new SHA512()).init(key, inputEncoding).update(msg, inputEncoding).digest(outputEncoding);
    } else {
        throw new TypeError(`Unsupported hash ${hash}. Must be one of SHA(1|256|512).`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvaG1hY0B2Mi4wLjEvbW9kLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNIQTEsIFNIQTI1NiwgU0hBNTEyLCBlbmNvZGUgfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5cbmNvbnN0IFNIQTFfUkVHRVg6IFJlZ0V4cCA9IC9eXFxzKnNoYS0/MVxccyokL2k7XG5jb25zdCBTSEEyNTZfUkVHRVg6IFJlZ0V4cCA9IC9eXFxzKnNoYS0/MjU2XFxzKiQvaTtcbmNvbnN0IFNIQTUxMl9SRUdFWDogUmVnRXhwID0gL15cXHMqc2hhLT81MTJcXHMqJC9pO1xuXG4vKiogQW4gaW50ZXJmYWNlIHJlcHJlc2VudGF0aW9uIG9mIGEgaGFzaCBhbGdvcml0aG0gaW1wbGVtZW50YXRpb24uICovXG5leHBvcnQgaW50ZXJmYWNlIEhhc2gge1xuICBoYXNoU2l6ZTogbnVtYmVyO1xuICBpbml0KCk6IEhhc2g7XG4gIHVwZGF0ZShtc2c6IHN0cmluZyB8IFVpbnQ4QXJyYXksIGlucHV0RW5jb2Rpbmc/OiBzdHJpbmcpOiBIYXNoO1xuICBkaWdlc3Qob3V0cHV0RW5jb2Rpbmc/OiBzdHJpbmcpOiBzdHJpbmcgfCBVaW50OEFycmF5O1xufVxuXG4vKiogQSBjbGFzcyByZXByZXNlbnRhdGlvbiBvZiB0aGUgSE1BQyBhbGdvcml0aG0uICovXG5leHBvcnQgY2xhc3MgSE1BQyB7XG4gIHJlYWRvbmx5IGhhc2hTaXplOiBudW1iZXI7XG4gIHJlYWRvbmx5IEI6IG51bWJlcjtcbiAgcmVhZG9ubHkgaVBhZDogbnVtYmVyO1xuICByZWFkb25seSBvUGFkOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBpS2V5UGFkITogVWludDhBcnJheTtcbiAgcHJpdmF0ZSBvS2V5UGFkITogVWludDhBcnJheTtcbiAgcHJpdmF0ZSBoYXNoZXI6IEhhc2g7XG5cbiAgLyoqIENyZWF0ZXMgYSBuZXcgSE1BQyBpbnN0YW5jZS4gKi9cbiAgY29uc3RydWN0b3IoaGFzaGVyOiBIYXNoLCBrZXk/OiBzdHJpbmcgfCBVaW50OEFycmF5KSB7XG4gICAgdGhpcy5oYXNoU2l6ZSA9IGhhc2hlci5oYXNoU2l6ZTtcbiAgICB0aGlzLmhhc2hlciA9IGhhc2hlcjtcbiAgICB0aGlzLkIgPSB0aGlzLmhhc2hTaXplIDw9IDMyID8gNjQgOiAxMjg7IC8vIGFjY29yZGluZyB0byBSRkM0ODY4XG4gICAgdGhpcy5pUGFkID0gMHgzNjtcbiAgICB0aGlzLm9QYWQgPSAweDVjO1xuXG4gICAgaWYgKGtleSkge1xuICAgICAgdGhpcy5pbml0KGtleSk7XG4gICAgfVxuICB9XG5cbiAgLyoqIEluaXRpYWxpemVzIGFuIEhNQUMgaW5zdGFuY2UuICovXG4gIGluaXQoa2V5OiBzdHJpbmcgfCBVaW50OEFycmF5LCBpbnB1dEVuY29kaW5nPzogc3RyaW5nKTogSE1BQyB7XG4gICAgaWYgKCFrZXkpIHtcbiAgICAgIGtleSA9IG5ldyBVaW50OEFycmF5KDApO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGtleSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAga2V5ID0gZW5jb2RlKGtleSwgaW5wdXRFbmNvZGluZykgYXMgVWludDhBcnJheTtcbiAgICB9XG5cbiAgICAvLyBwcm9jZXNzIHRoZSBrZXlcbiAgICBsZXQgX2tleTogVWludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KGtleSk7XG5cbiAgICBpZiAoX2tleS5sZW5ndGggPiB0aGlzLkIpIHtcbiAgICAgIC8vIGtleXMgbG9uZ2VyIHRoYW4gYmxvY2tzaXplIGFyZSBzaG9ydGVuZWRcbiAgICAgIHRoaXMuaGFzaGVyLmluaXQoKTtcbiAgICAgIF9rZXkgPSB0aGlzLmhhc2hlci51cGRhdGUoa2V5KS5kaWdlc3QoKSBhcyBVaW50OEFycmF5O1xuICAgIH1cblxuICAgIC8vIHplcm9wYWRyXG4gICAgaWYgKF9rZXkuYnl0ZUxlbmd0aCA8IHRoaXMuQikge1xuICAgICAgY29uc3QgdG1wOiBVaW50OEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5CKTtcbiAgICAgIHRtcC5zZXQoX2tleSwgMCk7XG4gICAgICBfa2V5ID0gdG1wO1xuICAgIH1cblxuICAgIC8vIHNldHVwIHRoZSBrZXkgcGFkc1xuICAgIHRoaXMuaUtleVBhZCA9IG5ldyBVaW50OEFycmF5KHRoaXMuQik7XG4gICAgdGhpcy5vS2V5UGFkID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5CKTtcblxuICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCB0aGlzLkI7ICsraSkge1xuICAgICAgdGhpcy5pS2V5UGFkW2ldID0gdGhpcy5pUGFkIF4gX2tleVtpXTtcbiAgICAgIHRoaXMub0tleVBhZFtpXSA9IHRoaXMub1BhZCBeIF9rZXlbaV07XG4gICAgfVxuXG4gICAgLy8gYmxhY2tvdXQga2V5XG4gICAgX2tleS5maWxsKDApO1xuXG4gICAgLy8gaW5pdGlhbCBoYXNoXG4gICAgdGhpcy5oYXNoZXIuaW5pdCgpO1xuICAgIHRoaXMuaGFzaGVyLnVwZGF0ZSh0aGlzLmlLZXlQYWQpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKiogVXBkYXRlIHRoZSBITUFDIHdpdGggYWRkaXRpb25hbCBtZXNzYWdlIGRhdGEuICovXG4gIHVwZGF0ZShcbiAgICBtc2c6IHN0cmluZyB8IFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheSgwKSxcbiAgICBpbnB1dEVuY29kaW5nPzogc3RyaW5nXG4gICk6IEhNQUMge1xuICAgIGlmICh0eXBlb2YgbXNnID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBtc2cgPSBlbmNvZGUobXNnLCBpbnB1dEVuY29kaW5nKSBhcyBVaW50OEFycmF5O1xuICAgIH1cblxuICAgIHRoaXMuaGFzaGVyLnVwZGF0ZShtc2cpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKiogRmluYWxpemUgdGhlIEhNQUMgd2l0aCBhZGRpdGlvbmFsIG1lc3NhZ2UgZGF0YS4gKi9cbiAgZGlnZXN0KG91dHB1dEVuY29kaW5nPzogc3RyaW5nKTogc3RyaW5nIHwgVWludDhBcnJheSB7XG4gICAgY29uc3Qgc3VtMTogVWludDhBcnJheSA9IHRoaXMuaGFzaGVyLmRpZ2VzdCgpIGFzIFVpbnQ4QXJyYXk7IC8vIGdldCBzdW0gMVxuXG4gICAgdGhpcy5oYXNoZXIuaW5pdCgpO1xuXG4gICAgcmV0dXJuIHRoaXMuaGFzaGVyXG4gICAgICAudXBkYXRlKHRoaXMub0tleVBhZClcbiAgICAgIC51cGRhdGUoc3VtMSlcbiAgICAgIC5kaWdlc3Qob3V0cHV0RW5jb2RpbmcpO1xuICB9XG59XG5cbi8qKiBSZXR1cm5zIGEgSE1BQyBvZiB0aGUgZ2l2ZW4gbXNnIGFuZCBrZXkgdXNpbmcgdGhlIGluZGljYXRlZCBoYXNoLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhtYWMoXG4gIGhhc2g6IHN0cmluZyxcbiAga2V5OiBzdHJpbmcgfCBVaW50OEFycmF5LFxuICBtc2c/OiBzdHJpbmcgfCBVaW50OEFycmF5LFxuICBpbnB1dEVuY29kaW5nPzogc3RyaW5nLFxuICBvdXRwdXRFbmNvZGluZz86IHN0cmluZ1xuKTogc3RyaW5nIHwgVWludDhBcnJheSB7XG4gIGlmIChTSEExX1JFR0VYLnRlc3QoaGFzaCkpIHtcbiAgICByZXR1cm4gbmV3IEhNQUMobmV3IFNIQTEoKSlcbiAgICAgIC5pbml0KGtleSwgaW5wdXRFbmNvZGluZylcbiAgICAgIC51cGRhdGUobXNnLCBpbnB1dEVuY29kaW5nKVxuICAgICAgLmRpZ2VzdChvdXRwdXRFbmNvZGluZyk7XG4gIH0gZWxzZSBpZiAoU0hBMjU2X1JFR0VYLnRlc3QoaGFzaCkpIHtcbiAgICByZXR1cm4gbmV3IEhNQUMobmV3IFNIQTI1NigpKVxuICAgICAgLmluaXQoa2V5LCBpbnB1dEVuY29kaW5nKVxuICAgICAgLnVwZGF0ZShtc2csIGlucHV0RW5jb2RpbmcpXG4gICAgICAuZGlnZXN0KG91dHB1dEVuY29kaW5nKTtcbiAgfSBlbHNlIGlmIChTSEE1MTJfUkVHRVgudGVzdChoYXNoKSkge1xuICAgIHJldHVybiBuZXcgSE1BQyhuZXcgU0hBNTEyKCkpXG4gICAgICAuaW5pdChrZXksIGlucHV0RW5jb2RpbmcpXG4gICAgICAudXBkYXRlKG1zZywgaW5wdXRFbmNvZGluZylcbiAgICAgIC5kaWdlc3Qob3V0cHV0RW5jb2RpbmcpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICBgVW5zdXBwb3J0ZWQgaGFzaCAke2hhc2h9LiBNdXN0IGJlIG9uZSBvZiBTSEEoMXwyNTZ8NTEyKS5gXG4gICAgKTtcbiAgfVxufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQVMsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLFlBQVk7QUFFekQsTUFBTSxhQUFxQjtBQUMzQixNQUFNLGVBQXVCO0FBQzdCLE1BQU0sZUFBdUI7QUFVN0Isa0RBQWtELEdBQ2xELE9BQU8sTUFBTTtJQUNGLFNBQWlCO0lBQ2pCLEVBQVU7SUFDVixLQUFhO0lBQ2IsS0FBYTtJQUVkLFFBQXFCO0lBQ3JCLFFBQXFCO0lBQ3JCLE9BQWE7SUFFckIsaUNBQWlDLEdBQ2pDLFlBQVksTUFBWSxFQUFFLEdBQXlCLENBQUU7UUFDbkQsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLFFBQVE7UUFDL0IsSUFBSSxDQUFDLE1BQU0sR0FBRztRQUNkLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxLQUFLLEtBQUssR0FBRyxFQUFFLHVCQUF1QjtRQUNoRSxJQUFJLENBQUMsSUFBSSxHQUFHO1FBQ1osSUFBSSxDQUFDLElBQUksR0FBRztRQUVaLElBQUksS0FBSztZQUNQLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDWixDQUFDO0lBQ0g7SUFFQSxrQ0FBa0MsR0FDbEMsS0FBSyxHQUF3QixFQUFFLGFBQXNCLEVBQVE7UUFDM0QsSUFBSSxDQUFDLEtBQUs7WUFDUixNQUFNLElBQUksV0FBVztRQUN2QixPQUFPLElBQUksT0FBTyxRQUFRLFVBQVU7WUFDbEMsTUFBTSxPQUFPLEtBQUs7UUFDcEIsQ0FBQztRQUVELGtCQUFrQjtRQUNsQixJQUFJLE9BQW1CLElBQUksV0FBVztRQUV0QyxJQUFJLEtBQUssTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFDeEIsMkNBQTJDO1lBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSTtZQUNoQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssTUFBTTtRQUN2QyxDQUFDO1FBRUQsV0FBVztRQUNYLElBQUksS0FBSyxVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUMsRUFBRTtZQUM1QixNQUFNLE1BQWtCLElBQUksV0FBVyxJQUFJLENBQUMsQ0FBQztZQUM3QyxJQUFJLEdBQUcsQ0FBQyxNQUFNO1lBQ2QsT0FBTztRQUNULENBQUM7UUFFRCxxQkFBcUI7UUFDckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLFdBQVcsSUFBSSxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLFdBQVcsSUFBSSxDQUFDLENBQUM7UUFFcEMsSUFBSyxJQUFJLElBQVksR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFHO1lBQ3ZDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUU7WUFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRTtRQUN2QztRQUVBLGVBQWU7UUFDZixLQUFLLElBQUksQ0FBQztRQUVWLGVBQWU7UUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUk7UUFDaEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU87UUFFL0IsT0FBTyxJQUFJO0lBQ2I7SUFFQSxrREFBa0QsR0FDbEQsT0FDRSxNQUEyQixJQUFJLFdBQVcsRUFBRSxFQUM1QyxhQUFzQixFQUNoQjtRQUNOLElBQUksT0FBTyxRQUFRLFVBQVU7WUFDM0IsTUFBTSxPQUFPLEtBQUs7UUFDcEIsQ0FBQztRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO1FBRW5CLE9BQU8sSUFBSTtJQUNiO0lBRUEsb0RBQW9ELEdBQ3BELE9BQU8sY0FBdUIsRUFBdUI7UUFDbkQsTUFBTSxPQUFtQixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBa0IsWUFBWTtRQUV6RSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUk7UUFFaEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUNuQixNQUFNLENBQUMsTUFDUCxNQUFNLENBQUM7SUFDWjtBQUNGLENBQUM7QUFFRCxzRUFBc0UsR0FDdEUsT0FBTyxTQUFTLEtBQ2QsSUFBWSxFQUNaLEdBQXdCLEVBQ3hCLEdBQXlCLEVBQ3pCLGFBQXNCLEVBQ3RCLGNBQXVCLEVBQ0Y7SUFDckIsSUFBSSxXQUFXLElBQUksQ0FBQyxPQUFPO1FBQ3pCLE9BQU8sSUFBSSxLQUFLLElBQUksUUFDakIsSUFBSSxDQUFDLEtBQUssZUFDVixNQUFNLENBQUMsS0FBSyxlQUNaLE1BQU0sQ0FBQztJQUNaLE9BQU8sSUFBSSxhQUFhLElBQUksQ0FBQyxPQUFPO1FBQ2xDLE9BQU8sSUFBSSxLQUFLLElBQUksVUFDakIsSUFBSSxDQUFDLEtBQUssZUFDVixNQUFNLENBQUMsS0FBSyxlQUNaLE1BQU0sQ0FBQztJQUNaLE9BQU8sSUFBSSxhQUFhLElBQUksQ0FBQyxPQUFPO1FBQ2xDLE9BQU8sSUFBSSxLQUFLLElBQUksVUFDakIsSUFBSSxDQUFDLEtBQUssZUFDVixNQUFNLENBQUMsS0FBSyxlQUNaLE1BQU0sQ0FBQztJQUNaLE9BQU87UUFDTCxNQUFNLElBQUksVUFDUixDQUFDLGlCQUFpQixFQUFFLEtBQUssZ0NBQWdDLENBQUMsRUFDMUQ7SUFDSixDQUFDO0FBQ0gsQ0FBQyJ9